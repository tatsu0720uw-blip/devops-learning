name: CI/CD Pipeline to GHCR

on:
  push:
    branches:
      - main

# ▼ 変更点1: GITHUB_TOKENの権限設定（パッケージへの書き込み権限を付与）
permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # ▼ 変更点2: GitHub Container Registry (GHCR) へのログイン
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # テスト実行（Linting）
      - name: Run Linting Test (Syntax Check)
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          flake8 .
          
      # ▼ 変更点3: ビルドしてプッシュを実行
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          # ここを true にすることで、ビルドしたイメージをレジストリに保存します
          push: true
          # タグの指定: ghcr.io/ユーザー名/イメージ名:タグ
          tags: ghcr.io/tatsu0720uw-blip/devops-app:latest

      - name: Success Message
        run: echo "CD Complete! Image pushed to GitHub Container Registry."