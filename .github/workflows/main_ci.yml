name: CI/CD Pipeline with Docker

# ワークフローを実行するトリガーを定義
on:
  push:
    branches:
      - main # mainブランチにプッシュされたら実行

# 実行するジョブ（タスク群）を定義
jobs:
  build-and-test:
    # ジョブを実行する仮想マシンを指定
    runs-on: ubuntu-latest
    
    steps:
      # 1. コードのチェックアウト (リポジトリの内容をVMに持ってくる)
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # 2. Dockerイメージのビルド (最も重要なCIステップ)
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .  # Dockerfileがある場所 (現在のディレクトリ)
          push: false # 今回はテストのためプッシュはしない
          tags: devops-app:latest
          
      # 3. テストの実行 (CIの品質保証ステップ)
      - name: Run Linting Test (Syntax Check)
        run: |
          # 仮想マシン内でPython環境を設定し、テストツールをインストール
          python -m pip install --upgrade pip
          pip install flake8
          
          # flake8 (Pythonの構文チェッカー) を実行
          # ここでエラーがあれば、パイプラインは失敗する
          flake8 . --ignore=E501
          
      # 4. (オプション) ビルド成功のメッセージ
      - name: Success Message
        run: echo "CI Pipeline Passed! Image Built and Tests Succeeded."